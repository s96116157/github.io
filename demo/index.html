<!doctype html>
<html lang="en">
<head>
    <title>Order</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" />
    <link href="css/jquery.dataTables.min.css" rel="stylesheet" />
    <script src="js/bootstrap.min.js"></script>
    <script src="js/Chart.min.js"></script>
    <script src="js/Chart.bundle.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/loader.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script type="text/javascript">
        // Load the Visualization API and the corechart package.
        google.charts.load('current', { 'packages': ['corechart'] });
        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawChart);
        load();

        function quesy() {
            document.getElementById("table_001").innerHTML = "";
            var id = document.getElementById("select_value").value;
            var query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1X5Mtln-MYBhyBRn0RveNOXCkb32A4VTzht1AIGkNvdU/edit#gid=0');
            if (id.length != 0) {
                query.setQuery("SELECT A,C,D,E,F,G where B=1 " + "and G=" + id.toString());
            }
            else {
                query.setQuery("SELECT A,C,D,E,F,G where B=1");
            }
            query.send(handleQueryResponse);
            //google.charts.setOnLoadCallback(drawChart);
        }

        function drawChart() {
            var query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1X5Mtln-MYBhyBRn0RveNOXCkb32A4VTzht1AIGkNvdU/edit#gid=0');
            query.setQuery("SELECT A,C,D,E,F,G where B=1");
            query.send(handleQueryResponse);
            console.log('查詢Excel');
        }

        function handleQueryResponse(response) {
            console.log('response', response);
            if (response.isError()) {
                alert("沒有此訂單編號。");
                //alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                return;
            }

            var data = response.getDataTable();
            var numrows = data.getNumberOfRows();
            var SYSID, Date, Item, Number, Price, Form_ID;
            console.log("response", response);
            console.log("data", data);
            //console.log("numrows", numrows);
            var a = "";

            for (var row = 0; row < numrows; row++) {
                SYSID = data.getValue(row, 0);
                Date = data.getValue(row, 1);
                Item = data.getValue(row, 2);
                Number = data.getValue(row, 3);
                Price = data.getValue(row, 4);
                Form_ID = data.getValue(row, 5).toString();
                //var B = data.getValue(row, 1);
                //var name = data.getValue(row, 2);
                //var value = data.getValue(row, 3);

                a += '<tr><td>' + SYSID +
                    '</td><td>' + Date +
                    '</td>><td>' + Item +
                    '</td>><td>' + Number +
                    '</td>><td>' + Price +
                    '</td>><td>' + Form_ID +
                    '</td></tr>';
            }

            $("#table_001").append(a);
        }

        function load() {
            var url = "https://script.google.com/macros/s/AKfycbwQerqt4HKL_H5hvFvshvMSwWrnAusvvd0eVhDFwViHNmSQZ2tm/exec";
            var parameter = {
                query: "",
                type: "read"
            };

            $.ajax({
                url: url,
                type: 'GET',
                data: parameter,
                success: function (data) {
                    var table_array = new Array();
                    var json_array = "";
                    var obj = JSON.parse('{"data":' + data + '}');
                    var col_infor = obj.data.table.cols; // Table_Name
                    var row_infor = obj.data.table.rows;

                    for (i = 0; i < col_infor.length; i++) {
                        table_array.push(col_infor[i].label);
                    }

                    //============================================

                    json_array += "[";
                    for (a = 0; a < row_infor.length; a++) {
                        json_array += '{';
                        for (b = 0; b < table_array.length; b++) {
                            json_array += '"';
                            json_array += table_array[b];
                            json_array += '":"';
                            json_array += row_infor[a].c[b].v;
                            json_array += '",'
                        }
                        json_array = json_array.slice(0, json_array.length - 1);
                        json_array += "},";
                    }
                    json_array = json_array.slice(0, json_array.length - 1);
                    json_array += "]";

                    //============================================

                    var test = JSON.parse(JSON.stringify(json_array));
                    var table = $('#data').DataTable({
                        destroy: true,
                        data: eval(test), "oLanguage": {
                            "sLengthMenu": "顯示 _MENU_ 筆記錄",
                            "sZeroRecords": "無符合資料",
                            "sInfo": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                            "sInfoFiltered": "(從 _MAX_ 項結果過濾)",
                            "sInfoPostFix": "",
                            "sSearch": "搜索:",
                            "sUrl": "",
                            "oPaginate": {
                                "sFirst": "首頁",
                                "sPrevious": "上頁",
                                "sNext": "下頁",
                                "sLast": "尾頁"
                            }
                        },
                        "columnDefs": [{
                            "targets": -1,
                            "data": null,
                            "searchable": false,
                            "paging": false,
                            "ordering": false,
                            "info": false
                        }],
                        columns: [
                            { data: "SYSID" },
                            { data: "Type" },
                            { data: "Date" },
                            { data: "Item" },
                            { data: "Number" }
                        ]
                    });
                    //==============================================================
                },
                error: function (data) {
                    alert("伺服器回應失敗，請重新再試一次。");
                }
            });
        }
    </script>

    <style>
        body {
            font-family: "Microsoft JhengHei",Helvetica,Arial,Verdana,sans-serif;
            color: white;
            font-size: 22px;
        }
    </style>
</head>
<body style="background-color: #333333;">
    <div style="margin: 10px;">
        <h1 style="color: white;">Checking your order</h1>
        <form>
            <br />
            查詢訂單：<input type="text" placeholder="訂單編號..." style="color: black" id="select_value">
            <button type="button" class="btn btn-success" onclick="quesy()">查詢</button>
            <br />
            <br />
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>訂購日期</th>
                        <th>名稱</th>
                        <th>數量</th>
                        <th>價格</th>
                        <th>訂單編號</th>
                    </tr>
                </thead>
                <tbody id="table_001">
                </tbody>
            </table>
            <div>
                <div class="row show-grid">
                    <div class="col-xs-6 col-md-4">
                        <div class="chartjs-wrapper">
                            <iframe class="chartjs-hidden-iframe" tabindex="-1" style="display: block; overflow: hidden; border: 0px; margin: 0px; top: 0px; left: 0px; bottom: 0px; right: 0px; height: 100%; width: 100%; position: absolute; pointer-events: none; z-index: -1;"></iframe>
                            <canvas id="chartjs-4" class="chartjs" width="667" height="333" style="display: block; height: 267px; width: 534px;"></canvas>

                        </div>
                    </div>
                    <div class="col-xs-6 col-md-4">
                        <div class="chartjs-wrapper">
                            <canvas id="chartjs-1" class="chartjs" width="656" height="327" style="display: block; height: 262px; width: 525px;"></canvas>
                        </div>
                    </div>

                    <div class="col-xs-6 col-md-4"></div>
                </div>

            </div>

            <div style="background-color: white; color: #333333">
                <table id="data" class="table table-bordered">
                    <thead>
                        <tr>
                            <th style="text-align: center;">編號</th>
                            <th style="text-align: center;">訂單狀態</th>
                            <th style="text-align: center;">訂購日期</th>
                            <th style="text-align: center;">品項名稱</th>
                            <th style="text-align: center;">訂購數量</th>
                        </tr>
                    </thead>
                </table>
            </div>


            <table style="color: white;"></table>
            <input type="button" class="btn btn-primary" value="A" onclick="Show_Value()">
            <input type="button" class="btn btn-primary" value="B" onclick="Destroy_Value()">
        </form>
    </div>
    <script type="text/javascript">
        function Destroy_Value() {
            new Chart(document.getElementById("chartjs-4"),
                {
                    "type": "doughnut", "data": {
                        "labels": ["A", "B", "C"],
                        "datasets": [{
                            "label": "My First Dataset", "data": [100, 150, 20],
                            "backgroundColor": ["rgb(255, 99, 132)", "rgb(54, 162, 235)", "rgb(255, 205, 86)"]
                        }]
                    }
                });
        };

        function Show_Value() {
            new Chart(document.getElementById("chartjs-4"),
                {
                    "type": "doughnut", "data": {
                        "labels": ["Red", "Blue", "Yellow"],
                        "datasets": [{
                            "label": "My First Dataset", "data": [300, 50, 100],
                            "backgroundColor": ["rgb(255, 99, 132)", "rgb(54, 162, 235)", "rgb(255, 205, 86)"]
                        }]
                    }
                });
            new Chart(document.getElementById("chartjs-1"),
                {
                    "type": "bar", "data": {
                        "labels": ["January", "February", "March", "April", "May", "June", "July"],
                        "datasets": [{
                            "label": "My First Dataset", "data": [65, 59, 80, 81, 56, 55, 40], "fill": false,
                            "backgroundColor": ["rgba(255, 99, 132, 0.2)", "rgba(255, 159, 64, 0.2)", "rgba(255, 205, 86, 0.2)", "rgba(75, 192, 192, 0.2)", "rgba(54, 162, 235, 0.2)", "rgba(153, 102, 255, 0.2)", "rgba(201, 203, 207, 0.2)"],
                            "borderColor": ["rgb(255, 99, 132)", "rgb(255, 159, 64)", "rgb(255, 205, 86)", "rgb(75, 192, 192)", "rgb(54, 162, 235)", "rgb(153, 102, 255)", "rgb(201, 203, 207)"],
                            "borderWidth": 1
                        }]
                    }, "options": {
                        "scales": {
                            "yAxes": [{
                                "ticks": {
                                    "beginAtZero": true
                                }
                            }]
                        }
                    }
                });
        }
    </script>
</body>
</html>
